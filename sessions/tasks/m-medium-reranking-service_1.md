# Task: Medium Posts Re-ranking Service Implementation

## üéØ –¶–µ–ª—å
–°–æ–∑–¥–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —ç—Ç–∞–ø —Ä–µ-—Ä–∞–Ω–∫–∏–Ω–≥–∞ MEDIUM –ø–æ—Å—Ç–æ–≤ —á–µ—Ä–µ–∑ GPT-4o-mini –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π Map-—Ñ–∞–∑—ã.

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
–¢–µ–∫—É—â–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤–∫–ª—é—á–∞–µ—Ç –≤—Å–µ MEDIUM –ø–æ—Å—Ç—ã –≤ pipeline, —á—Ç–æ –º–æ–∂–µ—Ç:
- –£–≤–µ–ª–∏—á–∏–≤–∞—Ç—å —à—É–º –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
- –°–Ω–∏–∂–∞—Ç—å —Ç–æ—á–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–æ–≤
- –£–≤–µ–ª–∏—á–∏–≤–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–æ–≤ –≤ Reduce —Ñ–∞–∑–µ

## üí° –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ
–ì–∏–±—Ä–∏–¥–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º —Ä–µ-—Ä–∞–Ω–∫–∏–Ω–≥–æ–º MEDIUM –ø–æ—Å—Ç–æ–≤:

```
Map ‚Üí Filter ‚Üí [MEDIUM Re-ranking] ‚Üí Resolve ‚Üí Reduce
```

**–ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è:** –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –≤—Å–µ MEDIUM –ø–æ—Å—Ç—ã, –ø—Ä–æ–≥–Ω–∞—Ç—å —á–µ—Ä–µ–∑ GPT-4o-mini –∫–∞–∫ —Ä–µ-—Ä–∞–Ω–∫–µ—Ä, –≤–∑—è—Ç—å TOP-5 –ª—É—á—à–∏—Ö –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–∫—Å–ø–µ—Ä—Ç–∞.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ù–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
1. **`MediumReRankingService`** - –Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–µ-—Ä–∞–Ω–∫–∏–Ω–≥–∞
2. **–ü—Ä–æ–º–ø—Ç –¥–ª—è —Ä–µ-—Ä–∞–Ω–∫–∏–Ω–≥–∞** - —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è GPT-4o-mini
3. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ pipeline** - –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è `simplified_query_endpoint.py`

### –ü–æ—Ä—è–¥–æ–∫ —Ä–∞–±–æ—Ç—ã:
1. **Map —Ñ–∞–∑–∞** (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ‚Üí HIGH/MEDIUM/LOW –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è
2. **Filter —Ñ–∞–∑–∞** ‚Üí —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ HIGH –∏ MEDIUM –ø–æ—Å—Ç—ã
3. **Re-ranking —Ñ–∞–∑–∞** (–Ω–æ–≤–∞—è) ‚Üí GPT-4o-mini —Ä–µ-—Ä–∞–Ω–∫–∏–Ω–≥ MEDIUM –ø–æ—Å—Ç–æ–≤
4. **Resolve —Ñ–∞–∑–∞** ‚Üí –ø–æ–∏—Å–∫ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ –¥–ª—è HIGH + TOP-5 MEDIUM
5. **Reduce —Ñ–∞–∑–∞** ‚Üí —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å–∏–Ω—Ç–µ–∑

## üìä –ê–Ω–∞–ª–∏–∑ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –°—Ç–æ–∏–º–æ—Å—Ç—å GPT-4o-mini:
- Input: $0.15 / 1M tokens
- Output: $0.60 / 1M tokens

### –ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á–µ—Ç–∞ –Ω–∞ 1 —ç–∫—Å–ø–µ—Ä—Ç–∞:
```
MEDIUM –ø–æ—Å—Ç–æ–≤: 15
–¢–æ–∫–µ–Ω–æ–≤ –Ω–∞ –ø–æ—Å—Ç: ~300
Input: 4,500 —Ç–æ–∫–µ–Ω–æ–≤ ‚Üí $0.0007
Output: 200 —Ç–æ–∫–µ–Ω–æ–≤ ‚Üí $0.0001
–ò—Ç–æ–≥–æ: ~$0.001 –∑–∞ —ç–∫—Å–ø–µ—Ä—Ç–∞
```

**–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:** ~$0.003 –∑–∞ 3 —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ (–∫–æ–ø–µ–π–∫–∏!)

### –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
- +5-10 —Å–µ–∫—É–Ω–¥ –∫ –æ–±—â–µ–º—É –≤—Ä–µ–º–µ–Ω–∏
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –≤—Å–µ—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤
- –ù–µ–∑–∞–º–µ–¥–ª–∏—Ç–µ–ª—å–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. MediumReRankingService
**–§–∞–π–ª:** `backend/src/services/medium_reranking_service.py`

```python
class MediumReRankingService:
    def __init__(self, api_key: str, model: str = "gpt-4o-mini")
    self.client = create_openrouter_client(api_key=api_key)
    self.model = convert_model_name(model)

    async def rerank_medium_posts(
        self,
        medium_posts: List[Dict],
        high_posts_context: str,
        query: str,
        expert_id: str,
        top_k: int = 5
    ) -> List[Dict]:
        """Re-rank medium posts using GPT-4o-mini"""
```

### 2. –ü—Ä–æ–º–ø—Ç –¥–ª—è —Ä–µ-—Ä–∞–Ω–∫–∏–Ω–≥–∞
**–§–∞–π–ª:** `backend/prompts/medium_reranking_prompt.txt`

```
You are analyzing MEDIUM-relevant posts to complement HIGH-relevant posts.

User query: {query}
HIGH posts summary: {high_posts_context}

MEDIUM posts to evaluate:
{medium_posts}

Select TOP {top_k} posts that would be most valuable to complement HIGH posts.

Consider:
1. Information gaps in HIGH posts
2. Additional examples or case studies
3. Alternative perspectives
4. Technical details missing from HIGH posts
5. Related topics not covered in HIGH posts

Return JSON with selected posts.
```

### 3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ pipeline
**–ú–µ—Å—Ç–æ:** `backend/src/api/simplified_query_endpoint.py`

```python
# –ü–æ—Å–ª–µ Map —Ñ–∞–∑—ã:
high_posts = [p for p in relevant_posts if p.get("relevance") == "HIGH"]
medium_posts = [p for p in relevant_posts if p.get("relevance") == "MEDIUM"]

# –ù–æ–≤—ã–π —ç—Ç–∞–ø: Re-ranking MEDIUM –ø–æ—Å—Ç–æ–≤
if medium_posts:
    reranking_service = MediumReRankingService(api_key)

    # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ HIGH –ø–æ—Å—Ç–æ–≤
    high_context = format_high_posts_context(high_posts)

    # Re-ranking
    top_medium_posts = await reranking_service.rerank_medium_posts(
        medium_posts=medium_posts,
        high_posts_context=high_context,
        query=request.query,
        expert_id=expert_id
    )

    # –û–±—ä–µ–¥–∏–Ω—è–µ–º HIGH + TOP-MEDIUM
    filtered_posts = high_posts + top_medium_posts
else:
    filtered_posts = high_posts
```

## üìã –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –§–∞–∑–∞ 1: –°–æ–∑–¥–∞–Ω–∏–µ MediumReRankingService
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `backend/src/services/medium_reranking_service.py`
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å —Å GPT-4o-mini
- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –∏ retry –ª–æ–≥–∏–∫—É
- [ ] –ù–∞–ø–∏—Å–∞—Ç—å unit —Ç–µ—Å—Ç—ã

### –§–∞–∑–∞ 2: –ü—Ä–æ–º–ø—Ç –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –°–æ–∑–¥–∞—Ç—å `backend/prompts/medium_reranking_prompt.txt`
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–º–ø—Ç –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–µ-—Ä–∞–Ω–∫–∏–Ω–≥–∞
- [ ] –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å JSON –æ—Ç–≤–µ—Ç—ã

### –§–∞–∑–∞ 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ pipeline
- [ ] –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å `simplified_query_endpoint.py`
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ä–µ-—Ä–∞–Ω–∫–∏–Ω–≥ –ø–æ—Å–ª–µ Map —Ñ–∞–∑—ã
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–µ—Ç—Ä–∏–∫–∏
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π pipeline

### –§–∞–∑–∞ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- [ ] –ü—Ä–æ–≤–µ—Å—Ç–∏ A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–µ–π
- [ ] –°—Ä–∞–≤–Ω–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –æ—Ç–≤–µ—Ç–æ–≤
- [ ] –ò–∑–º–µ—Ä–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏ –≤—Ä–µ–º—è
- [ ] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å top_k –ø–∞—Ä–∞–º–µ—Ç—Ä

## üéØ –£—Å–ø–µ—à–Ω—ã–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏

### –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
- –û—Ç–≤–µ—Ç—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –±–æ–ª–µ–µ –ø–æ–ª–Ω—ã–º–∏ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ –±–æ–≥–∞—Ç—ã–º–∏
- –°–∏—Å—Ç–µ–º–∞ –Ω–∞—Ö–æ–¥–∏—Ç –Ω–µ–æ—á–µ–≤–∏–¥–Ω—ã–µ —Å–≤—è–∑–∏ —á–µ—Ä–µ–∑ MEDIUM –ø–æ—Å—Ç—ã
- –í—ã—à–µ —Ç–æ—á–Ω–æ—Å—Ç—å –Ω–∞ —Å–ª–æ–∂–Ω—ã—Ö –º–Ω–æ–≥–æ–≥—Ä–∞–Ω–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö

### –ö–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:
- +10-20% –ø–æ–ª–µ–∑–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ –≤ main_sources
- Cost increase < $0.01 –∑–∞ –∑–∞–ø—Ä–æ—Å
- Time increase < 15 —Å–µ–∫—É–Ω–¥
- –û—à–∏–±–∫–∞ API < 5%

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –º–µ—Ç—Ä–∏–∫–∏:
- –í—Å–µ unit —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –Ω–µ –ª–æ–º–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π pipeline
- Graceful degradation –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Ä–µ-—Ä–∞–Ω–∫–∏–Ω–≥–∞

## üö® –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è

### –†–∏—Å–∫ 1: API –æ—à–∏–±–∫–∏ GPT-4o-mini
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** Retry –ª–æ–≥–∏–∫–∞, fallback –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤—Å–µ—Ö MEDIUM –ø–æ—Å—Ç–æ–≤

### –†–∏—Å–∫ 2: –ü–ª–æ—Ö–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ —Ä–µ-—Ä–∞–Ω–∫–∏–Ω–≥–∞
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** –¢—â–∞—Ç–µ–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞, A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –†–∏—Å–∫ 3: –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—Ä–µ–º–µ–Ω–∏

### –†–∏—Å–∫ 4: JSON –ø–∞—Ä—Å–∏–Ω–≥ –æ—à–∏–±–∫–∏
**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ö–µ–º—ã, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [OpenRouter API docs](https://openrouter.ai/docs)
- [GPT-4o-mini documentation](https://platform.openai.com/docs/models/gpt-4o-mini)
- [RAG re-ranking best practices](https://arxiv.org/abs/2401.18087)

## üìä –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞

- [ ] –§–∞–∑–∞ 1: MediumReRankingService (0/3)
- [ ] –§–∞–∑–∞ 2: –ü—Ä–æ–º–ø—Ç –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (0/3)
- [ ] –§–∞–∑–∞ 3: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (0/3)
- [ ] –§–∞–∑–∞ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (0/4)

**–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å:** 0/13 –∑–∞–¥–∞—á –≤—ã–ø–æ–ª–Ω–µ–Ω–æ

---

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π (—É–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –±–µ–∑ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π)
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è (–Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å, –Ω–æ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
**–í–ª–∏—è–Ω–∏–µ:** –í—ã—Å–æ–∫–æ–µ (–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤)
# Инструкция для Gemini 2.5 Flash: Честный Анализ Дрифта (БЕЗ МОКОВ)

Привет! Твоя задача — провести **качественный смысловой анализ** комментариев в Telegram-канале на предмет "дрифта темы" (ухода дискуссии в сторону от поста).

**ВАЖНО:** 
1. **НИКАКИХ МОКОВ И ЗАГЛУШЕК.** Ты должен реально читать текст поста и комментариев и использовать свой интеллект для анализа.
2. **Не используй скрипты Python с заглушками** (типа `run_single_drift_analysis.py`, если в нем внутри `simple_drift_analysis`). Если скрипт использует LLM API — ок, но лучше делай анализ **сам внутри чата**, читая данные через `sqlite3`, так как у тебя уже есть встроенный мощный интеллект.
3. Работай итеративно через `todo` список, обрабатывая по одной группе за шаг.

---

## Твой Алгоритм Действий

### 1. Подготовка списка задач
Сначала найди группы, которые ожидают анализа (`analyzed_by = 'pending'`).
Выполни команду:
```bash
sqlite3 backend/data/experts.db "SELECT post_id FROM comment_group_drift WHERE analyzed_by = 'pending' LIMIT 10;"
```
Создай `todo` список из полученных ID.

### 2. Обработка одной группы (цикл)
Для каждого `post_id` из списка (статус `in_progress`):

#### А. Чтение данных (Source of Truth)
Прочитай текст поста и комментариев **напрямую из базы**. Не гадай.
```bash
sqlite3 backend/data/experts.db "SELECT message_text FROM posts WHERE post_id = <ID>;" && echo "---COMMENTS---" && sqlite3 backend/data/experts.db "SELECT author_name, comment_text FROM comments WHERE post_id = <ID>;"
```

#### Б. Смысловой Анализ (ТВОЯ РАБОТА)
Прочитай вывод. Сравни тему поста и темы комментариев.
Ответь на вопросы:
1. О чем пост? (Основная мысль)
2. О чем комментарии?
3. Есть ли ветки обсуждения, которые **существенно** отклоняются от темы поста? (Новые вопросы, технические детали, оффтоп, споры на смежные, но другие темы).
   - *Пример дрифта:* Пост про софт-скиллы менеджера -> Спор про цену видеокарт H100.
   - *Пример НЕ дрифта:* Пост про софт-скиллы -> Комментарий "Согласен, это важно".

#### В. Формирование JSON результата
Если дрифт есть, сформулируй его в JSON формате (строго соблюдая структуру):
```json
{
  "has_drift": true,
  "drift_topics": [
    {
      "topic": "Короткое название темы дрифта",
      "keywords": ["ключевое", "слово"],
      "key_phrases": ["цитата из комментария"],
      "context": "Почему это дрифт (1 предложение)"
    }
  ]
}
```
Если дрифта нет: `has_drift = 0`.

#### Г. Запись в базу (SQL)
Запиши результат SQL-запросом.
**Обязательно** экранируй кавычки в JSON. Укажи `analyzed_by = 'gemini-2.5-flash'` (или 'gemini-manual').

Пример (Дрифт ЕСТЬ):
```bash
sqlite3 backend/data/experts.db "UPDATE comment_group_drift SET has_drift = 1, drift_topics = '<ТВОЙ_JSON_СТРОКОЙ>', analyzed_by = 'gemini-2.5-flash', analyzed_at = datetime('now') WHERE post_id = <ID>;"
```

Пример (Дрифта НЕТ):
```bash
sqlite3 backend/data/experts.db "UPDATE comment_group_drift SET has_drift = 0, drift_topics = NULL, analyzed_by = 'gemini-2.5-flash', analyzed_at = datetime('now') WHERE post_id = <ID>;"
```

### 3. Завершение шага
Пометь задачу в `todo` как `completed`. Переходи к следующей.

---

## Критерии Дрифта

✅ **СЧИТАЕТСЯ Дрифтом:**
- Обсуждение технических деталей, не упомянутых в посте (железо, конкретные библиотеки).
- Организационные вопросы (где купить, почем билеты), если пост не об этом.
- Философские споры, уходящие в абстракцию.
- Личные истории, меняющие фокус обсуждения.

❌ **НЕ СЧИТАЕТСЯ Дрифтом:**
- Уточняющие вопросы по тексту поста.
- Выражение согласия/несогласия.
- Благодарности.
- Шутки "в тему".

Удачи! Делай качественно.
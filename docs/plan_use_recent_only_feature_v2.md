# ĞŸĞ»Ğ°Ğ½: Ğ¤Ğ¸Ñ‡Ğ° "use_recent_only" - Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ´Ğ°Ñ‚Ğµ (3 Ğ¼ĞµÑÑÑ†Ğ°) v2

**Ğ”Ğ°Ñ‚Ğ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ:** 2026-02-04  
**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ğ½ (Ğ³Ğ¾Ñ‚Ğ¾Ğ² Ğº Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸)  
**ĞĞ²Ñ‚Ğ¾Ñ€:** Claude (Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ)

---

## ğŸ“‹ ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ñ„Ğ¸Ñ‡Ğ¸

Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² UI Ğ³Ğ°Ğ»Ğ¾Ñ‡ĞºÑƒ "Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 3 Ğ¼ĞµÑÑÑ†Ğ°" (use_recent_only), ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ°Ñ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ¸ÑĞº Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ² Ğ¸ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸ĞµĞ² Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ¾Ğ¼ Ğ² 3 Ğ¼ĞµÑÑÑ†Ğ°.

### ĞŸĞ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ:
- **OFF (default):** Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ÑÑ Ğ²ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· Ğ‘Ğ” (Ğ´Ğ»Ñ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ğ¸, Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸, Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°)
- **ON:** Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾ÑÑ‚Ñ‹ Ğ¸ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¸ Ğ·Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 3 Ğ¼ĞµÑÑÑ†Ğ° (Ğ´Ğ»Ñ ÑĞ²ĞµĞ¶Ğ¸Ñ… Ğ½Ğ¾Ğ²Ğ¾ÑÑ‚ĞµĞ¹, Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹)

### âš ï¸ Ğ’Ğ°Ğ¶Ğ½Ñ‹Ğµ Ğ½ÑĞ°Ğ½ÑÑ‹:
1. **Ğ¡Ğ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾ÑÑ‚Ñ‹ (Resolve):** Ğ•ÑĞ»Ğ¸ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€, ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾ÑÑ‚Ñ‹ ÑÑ‚Ğ°Ñ€ÑˆĞµ 3 Ğ¼ĞµÑÑÑ†ĞµĞ² ĞĞ• Ğ¿Ğ¾Ğ´Ñ‚ÑĞ³Ğ¸Ğ²Ğ°ÑÑ‚ÑÑ
2. **Ğ¡ÑÑ‹Ğ»ĞºĞ¸ [post:ID] Ğ² Ğ¾Ñ‚Ğ²ĞµÑ‚Ğµ:** LLM Ğ½Ğµ Ğ±ÑƒĞ´ĞµÑ‚ ÑÑÑ‹Ğ»Ğ°Ñ‚ÑŒÑÑ Ğ½Ğ° ÑÑ‚Ğ°Ñ€Ñ‹Ğµ Ğ¿Ğ¾ÑÑ‚Ñ‹, Ñ‚.Ğº. Ğ¾Ğ½Ğ¸ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒÑÑ‚ Ğ² ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğµ
3. **ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¸:** Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ÑÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğº Ğ¿Ğ¾ÑÑ‚Ğ°Ğ¼, Ğ¿Ñ€Ğ¾ÑˆĞµĞ´ÑˆĞ¸Ğ¼ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ (Ñ‚.Ğµ. ÑĞ²ĞµĞ¶Ğ¸Ğ¼)
4. **Drift groups:** ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ ÑĞ²ĞµĞ¶Ğ¸Ñ… Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ²

---

## ğŸ—ï¸ Ğ£Ğ¿Ñ€Ğ¾Ñ‰Ñ‘Ğ½Ğ½Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

**ĞšĞ»ÑÑ‡ĞµĞ²Ğ¾Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ:** Ğ’Ğ¼ĞµÑÑ‚Ğ¾ Ğ¿Ñ€Ğ¾ĞºĞ¸Ğ´Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ `use_recent_only` Ñ‡ĞµÑ€ĞµĞ· Ğ²ÑĞµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹, Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ÑÑ:

1. **ĞĞ° ÑƒÑ€Ğ¾Ğ²Ğ½Ğµ endpoint** â€” Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ²
2. **Ğ’ resolve-ÑĞµÑ€Ğ²Ğ¸ÑĞµ** â€” Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ² (Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‘Ğ¼ `cutoff_date`)
3. **Ğ’ comment-ÑĞµÑ€Ğ²Ğ¸ÑĞµ** â€” Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ drift groups (Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‘Ğ¼ `cutoff_date`)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  simplified_query_endpoint.py                               â”‚
â”‚  â”œâ”€ Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ cutoff_date = now - 3 months                     â”‚
â”‚  â”œâ”€ Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ²: WHERE created_at >= cutoff_date      â”‚
â”‚  â”œâ”€ ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ° cutoff_date Ğ² resolve (ĞµÑĞ»Ğ¸ use_recent_only)   â”‚
â”‚  â””â”€ ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ° cutoff_date Ğ² comment groups (ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â†“                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SimpleResolveService    â”‚      â”‚  CommentGroupMapService  â”‚
â”‚  â”œâ”€ _get_linked_posts    â”‚      â”‚  â”œâ”€ _load_drift_groups   â”‚
â”‚  â””â”€ _fetch_posts_by_ids  â”‚      â”‚  â””â”€ cutoff_date filter   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Ğ¤Ğ°Ğ¹Ğ»Ñ‹ Ğ´Ğ»Ñ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ

### 1. `backend/src/api/models.py`

Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğµ Ğ² `QueryRequest`:

```python
use_recent_only: Optional[bool] = Field(
    default=False,
    description="Use only recent data (last 3 months) for fresh news and current models. "
                "When false, uses all available data for comprehensive answers including "
                "methodology and historical context."
)
```

---

### 2. `backend/src/api/simplified_query_endpoint.py`

**ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ²** (lines ~108-115):

```python
# Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ cutoff_date
from datetime import datetime, timedelta

def get_cutoff_date():
    """Get cutoff date for 'recent only' filter (3 months ago, UTC)."""
    now = datetime.utcnow()
    # Subtract 3 months (accounting for different month lengths)
    month = now.month - 3
    year = now.year
    if month <= 0:
        month += 12
        year -= 1
    # Handle day overflow (e.g., March 31 - 3 months = Dec 31, not Dec 31->invalid)
    try:
        return now.replace(year=year, month=month)
    except ValueError:
        # For days that don't exist in target month (e.g., March 31 -> Feb 30)
        # Use last day of target month
        import calendar
        last_day = calendar.monthrange(year, month)[1]
        return now.replace(year=year, month=month, day=last_day)

# Ğ’ process_expert_pipeline():
cutoff_date = None
if request.use_recent_only:
    cutoff_date = get_cutoff_date()
    logger.info(f"[{expert_id}] use_recent_only enabled, cutoff_date: {cutoff_date.isoformat()}")

# Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ²
query = db.query(Post).filter(Post.expert_id == expert_id)

if cutoff_date:
    query = query.filter(Post.created_at >= cutoff_date)

if request.max_posts is not None:
    query = query.limit(request.max_posts)

posts = query.order_by(Post.created_at.desc()).all()

# ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ° cutoff_date Ğ² resolve (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ use_recent_only)
if high_posts:
    resolve_service = SimpleResolveService()
    high_resolve_results = await resolve_service.process(
        relevant_posts=high_posts,
        query=request.query,
        expert_id=expert_id,
        cutoff_date=cutoff_date,  # <-- ĞŸĞ•Ğ Ğ•Ğ”ĞĞĞœ cutoff_date
        progress_callback=resolve_progress
    )

# ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ° cutoff_date Ğ² comment groups
cg_service = CommentGroupMapService(model=config.MODEL_COMMENT_GROUPS)
comment_group_results = await cg_service.process(
    query=request.query,
    db=db,
    expert_id=expert_id,
    exclude_post_ids=main_sources,
    main_source_ids=main_sources,
    cutoff_date=cutoff_date,  # <-- ĞŸĞ•Ğ Ğ•Ğ”ĞĞĞœ cutoff_date
    progress_callback=cg_progress
)
```

---

### 3. `backend/src/services/simple_resolve_service.py`

**Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ÑĞ¸Ğ³Ğ½Ğ°Ñ‚ÑƒÑ€Ñƒ `process()`:**

```python
async def process(
    self,
    relevant_posts: List[Dict[str, Any]],
    query: str,
    expert_id: str,
    cutoff_date: Optional[datetime] = None,  # <-- ĞĞĞ’Ğ«Ğ™ ĞŸĞĞ ĞĞœĞ•Ğ¢Ğ 
    progress_callback: Optional[Callable] = None
) -> Dict[str, Any]:
```

**Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ `_get_linked_posts()`:**

```python
def _get_linked_posts(
    self,
    db: Session,
    initial_post_ids: Set[int],
    expert_id: str,
    cutoff_date: Optional[datetime] = None  # <-- ĞĞĞ’Ğ«Ğ™ ĞŸĞĞ ĞĞœĞ•Ğ¢Ğ 
) -> Set[int]:
    # ... existing code ...
    
    # Convert database IDs back to telegram_message_ids Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ¼ Ğ¿Ğ¾ Ğ´Ğ°Ñ‚Ğµ
    if linked_db_ids:
        linked_posts_query = db.query(Post).filter(
            Post.post_id.in_(linked_db_ids),
            Post.expert_id == expert_id
        )
        
        # Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ´Ğ°Ñ‚Ğµ ĞµÑĞ»Ğ¸ Ğ·Ğ°Ğ´Ğ°Ğ½
        if cutoff_date:
            linked_posts_query = linked_posts_query.filter(
                Post.created_at >= cutoff_date
            )
        
        linked_posts = linked_posts_query.all()
        
        for post in linked_posts:
            linked_telegram_ids.add(post.telegram_message_id)
    
    logger.info(
        f"[{expert_id}] Expanded {len(initial_post_ids)} posts to {len(linked_telegram_ids)} "
        f"(+{len(linked_telegram_ids) - len(initial_post_ids)} linked posts)"
        f"{' (filtered by date)' if cutoff_date else ''}"
    )
    
    return linked_telegram_ids
```

**Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ `_fetch_posts_by_telegram_ids()`:**

```python
def _fetch_posts_by_telegram_ids(
    self,
    db: Session,
    telegram_message_ids: List[int],
    expert_id: str,
    cutoff_date: Optional[datetime] = None  # <-- ĞĞĞ’Ğ«Ğ™ ĞŸĞĞ ĞĞœĞ•Ğ¢Ğ 
) -> Dict[int, Post]:
    if not telegram_message_ids:
        return {}
    
    query = db.query(Post).filter(
        Post.telegram_message_id.in_(telegram_message_ids),
        Post.expert_id == expert_id
    )
    
    # Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ´Ğ°Ñ‚Ğµ ĞµÑĞ»Ğ¸ Ğ·Ğ°Ğ´Ğ°Ğ½
    if cutoff_date:
        query = query.filter(Post.created_at >= cutoff_date)
    
    posts = query.all()
    
    return {post.telegram_message_id: post for post in posts}
```

**ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ñ‹ Ğ² `process()`:**

```python
# Get all linked posts at depth 1
all_post_ids = self._get_linked_posts(
    db,
    set(relevant_ids),
    expert_id,
    cutoff_date=cutoff_date  # <-- ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‘Ğ¼
)

# Fetch all posts (original + linked)
posts_map = self._fetch_posts_by_telegram_ids(
    db, list(all_post_ids), expert_id,
    cutoff_date=cutoff_date  # <-- ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‘Ğ¼
)
```

---

### 4. `backend/src/services/comment_group_map_service.py`

**Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ÑĞ¸Ğ³Ğ½Ğ°Ñ‚ÑƒÑ€Ñƒ `process()`:**

```python
async def process(
    self,
    query: str,
    db: Session,
    expert_id: str,
    exclude_post_ids: Optional[List[int]] = None,
    main_source_ids: Optional[List[int]] = None,
    cutoff_date: Optional[datetime] = None,  # <-- ĞĞĞ’Ğ«Ğ™ ĞŸĞĞ ĞĞœĞ•Ğ¢Ğ 
    progress_callback: Optional[Callable] = None
) -> List[Dict[str, Any]]:
```

**Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ `_load_drift_groups()`:**

```python
def _load_drift_groups(
    self,
    db: Session,
    expert_id: str,
    exclude_post_ids: Optional[List[int]] = None,
    cutoff_date: Optional[datetime] = None  # <-- ĞĞĞ’Ğ«Ğ™ ĞŸĞĞ ĞĞœĞ•Ğ¢Ğ 
) -> List[Dict[str, Any]]:
    
    # Query drift groups with anchor posts
    query = db.query(
        comment_group_drift.c.post_id,
        comment_group_drift.c.drift_topics,
        Post.telegram_message_id,
        Post.message_text,
        Post.created_at,
        Post.author_name
    ).join(
        Post, comment_group_drift.c.post_id == Post.post_id
    ).filter(
        comment_group_drift.c.has_drift == True,
        comment_group_drift.c.expert_id == expert_id
    )
    
    # Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ¿Ğ¾ Ğ´Ğ°Ñ‚Ğµ ĞµÑĞ»Ğ¸ Ğ·Ğ°Ğ´Ğ°Ğ½
    if cutoff_date:
        query = query.filter(Post.created_at >= cutoff_date)
    
    if exclude_post_ids:
        validated_ids = [pid for pid in exclude_post_ids if isinstance(pid, int) and pid > 0]
        if validated_ids:
            query = query.filter(Post.telegram_message_id.notin_(validated_ids))
    
    results = query.all()
    # ... rest of method
```

**ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ²Ñ‹Ğ·Ğ¾Ğ² Ğ² `process()`:**

```python
# Load drift groups from database (excluding main_sources as before)
all_groups = self._load_drift_groups(db, expert_id, exclude_post_ids, cutoff_date=cutoff_date)
```

---

### 5. `frontend/src/types/api.ts`

Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğµ Ğ² Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ `QueryRequest`:

```typescript
export interface QueryRequest {
  query: string;
  max_posts?: number;
  include_comments?: boolean;
  include_comment_groups?: boolean;
  stream_progress?: boolean;
  expert_filter?: string[];
  
  // ĞĞĞ’ĞĞ• ĞŸĞĞ›Ğ•:
  use_recent_only?: boolean;
}
```

---

### 6. `frontend/src/components/QueryForm.tsx`

Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ‡ĞµĞºĞ±Ğ¾ĞºÑ Ğ¸ state:

```typescript
// State
const [useRecentOnly, setUseRecentOnly] = useState(false);

// ĞŸÑ€Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞµ
onSubmit(trimmed, { use_recent_only: useRecentOnly });

// JSX
<label className="recent-only-checkbox">
  <input
    type="checkbox"
    checked={useRecentOnly}
    onChange={(e) => setUseRecentOnly(e.target.checked)}
    disabled={disabled}
  />
  <span>ğŸ•’ Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 3 Ğ¼ĞµÑÑÑ†Ğ°</span>
  <small>Ğ¡Ğ²ĞµĞ¶Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾ÑÑ‚Ğ¸ Ğ¸ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸</small>
</label>
```

---

## ğŸ”§ Ğ¢ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸

### Ğ Ğ°ÑÑ‡Ñ‘Ñ‚ "3 Ğ¼ĞµÑÑÑ†ĞµĞ² Ğ½Ğ°Ğ·Ğ°Ğ´":

```python
from datetime import datetime
import calendar

def get_cutoff_date():
    """Get cutoff date for 'recent only' filter (3 months ago, UTC).
    
    Handles month boundary correctly:
    - March 31 - 3 months = Dec 31
    - May 31 - 3 months = Feb 28/29
    """
    now = datetime.utcnow()
    month = now.month - 3
    year = now.year
    
    if month <= 0:
        month += 12
        year -= 1
    
    # Handle day overflow (e.g., March 31 -> Dec 31, not invalid)
    try:
        return now.replace(year=year, month=month)
    except ValueError:
        # Day doesn't exist in target month (e.g., May 31 -> Feb 30)
        last_day = calendar.monthrange(year, month)[1]
        return now.replace(year=year, month=month, day=last_day)
```

### SQL Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸:

```sql
-- ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ñ€Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ² Ğ¿Ğ¾ Ğ´Ğ°Ñ‚Ğ°Ğ¼
SELECT 
    CASE 
        WHEN created_at >= datetime('now', '-3 months') THEN 'Ğ¡Ğ²ĞµĞ¶Ğ¸Ğµ (3 Ğ¼ĞµÑ)'
        ELSE 'Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğµ'
    END as category,
    COUNT(*) as count,
    ROUND(100.0 * COUNT(*) / SUM(COUNT(*)) OVER (), 1) as percent
FROM posts
GROUP BY category;

-- ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ğ¾Ğ³Ğ¾ ÑĞºÑĞ¿ĞµÑ€Ñ‚Ğ°
SELECT 
    CASE 
        WHEN created_at >= datetime('now', '-3 months') THEN 'recent'
        ELSE 'old'
    END as category,
    COUNT(*) as count
FROM posts 
WHERE expert_id = 'akimov'
GROUP BY category;
```

---

## âœ… Ğ§ĞµĞºĞ»Ğ¸ÑÑ‚ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

- [ ] Ğ§ĞµĞºĞ±Ğ¾ĞºÑ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµÑ‚ÑÑ Ğ² UI
- [ ] Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‘Ñ‚ÑÑ Ğ² API Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞµ
- [ ] Backend ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµÑ‚ Ğ¿Ğ¾ÑÑ‚Ñ‹ (Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸)
- [ ] Ğ¡Ğ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾ÑÑ‚Ñ‹ ÑÑ‚Ğ°Ñ€ÑˆĞµ 3 Ğ¼ĞµÑ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ñ‚ÑĞ³Ğ¸Ğ²Ğ°ÑÑ‚ÑÑ
- [ ] Drift groups Ğ´Ğ»Ñ ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ² Ğ½Ğµ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ÑÑ‚ÑÑ
- [ ] ĞŸÑ€Ğ¸ OFF Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑÑ‚ÑÑ Ğ²ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
- [ ] Ğ¡ĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ¼ Ğ²Ñ‹ÑˆĞµ (Ğ¼ĞµĞ½ÑŒÑˆĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…)
- [ ] ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚ "3 Ğ¼ĞµÑÑÑ†ĞµĞ²" (Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´ Ñ‡ĞµÑ€ĞµĞ· Ğ³Ğ¾Ğ´)

---

## ğŸ¨ UI/UX Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸

### Ğ¢ĞµĞºÑÑ‚ Ñ‡ĞµĞºĞ±Ğ¾ĞºÑĞ°:
- **Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº:** "ğŸ•’ Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 3 Ğ¼ĞµÑÑÑ†Ğ°"
- **ĞŸĞ¾Ğ´ÑĞºĞ°Ğ·ĞºĞ°:** "Ğ”Ğ»Ñ ÑĞ²ĞµĞ¶Ğ¸Ñ… Ğ½Ğ¾Ğ²Ğ¾ÑÑ‚ĞµĞ¹ Ğ¸ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹. Ğ’Ñ‹ĞºĞ»ÑÑ‡Ğ¸Ñ‚Ğµ Ğ´Ğ»Ñ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ğ¸ Ğ¸ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ³Ğ¾ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°."

### ĞŸĞ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ:
- ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ: **OFF** (Ğ²ÑĞµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ)
- Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğµ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑŒ Ğ² localStorage (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
- ĞŸÑ€Ğ¸ Ğ½Ğ°Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğ¸ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ tooltip Ñ Ğ¿Ğ¾ÑÑĞ½ĞµĞ½Ğ¸ĞµĞ¼

---

## ğŸ“ Ğ¡Ğ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹

- `backend/src/api/models.py` â€” API Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸
- `backend/src/api/simplified_query_endpoint.py` â€” Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ
- `backend/src/services/simple_resolve_service.py` â€” Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ²
- `backend/src/services/comment_group_map_service.py` â€” Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ drift groups
- `frontend/src/types/api.ts` â€” TypeScript Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑÑ‹
- `frontend/src/components/QueryForm.tsx` â€” UI ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚

---

## âš ï¸ Ğ§ĞµĞ³Ğ¾ ĞĞ• Ğ½Ğ°Ğ´Ğ¾ Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ

1. **ĞĞµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑÑ‚ÑŒ** `use_recent_only` Ğ² `MapService.process()` â€” Ğ¿Ğ¾ÑÑ‚Ñ‹ ÑƒĞ¶Ğµ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ² endpoint'Ğµ
2. **ĞĞµ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ** `comments.created_at` Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ â€” Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· Ğ¿Ğ¾ÑÑ‚Ñ‹
3. **ĞĞµ Ğ¼ĞµĞ½ÑÑ‚ÑŒ** ReduceService, CommentSynthesisService, LanguageValidationService â€” Ğ¾Ğ½Ğ¸ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‚ Ñ ÑƒĞ¶Ğµ Ğ¾Ñ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸

---

**ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½ĞµĞµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ:** 2026-02-04  
**Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ğ½ (Ğ³Ğ¾Ñ‚Ğ¾Ğ² Ğº Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸)
